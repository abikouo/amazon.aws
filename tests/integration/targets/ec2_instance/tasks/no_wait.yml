---
- block:
    # Test create instance with wait set to false
    - name: "New instance and don't wait for it to complete (check_mode)"
      ec2_instance:
        state: present
        name: "{{ ec2_test_name }}"
        image_id: "{{ ec2_ami_id }}"
        vpc_subnet_id: "{{ testing_subnet_b.subnet.id }}"
        tags:
          TestId: "{{ ec2_instance_tag_TestId }}"
        wait: false
        instance_type: "{{ ec2_instance_type }}"
      register: _create_instance_check_mode
      check_mode: true

    - assert:
        that:
        - _create_instance_check_mode is changed
        - _create_instance_check_mode.instance_ids is not defined
        - _create_instance_check_mode.msg == "Would have launched instances if not in check_mode."

    - name: Gather instance info
      ec2_instance_info:
        filters:
          "tag:Name": "{{ ec2_test_name }}"
      register: _instances_info

    - name: Validate that the instance was not created using check mode
      assert:
        that:
          - _instances_info.instances | length == 0

    - name: "New instance and don't wait for it to complete"
      ec2_instance:
        state: present
        name: "{{ ec2_test_name }}"
        image_id: "{{ ec2_ami_id }}"
        vpc_subnet_id: "{{ testing_subnet_b.subnet.id }}"
        tags:
          TestId: "{{ ec2_instance_tag_TestId }}"
        wait: false
        instance_type: "{{ ec2_instance_type }}"
      register: _create_instance

    - assert:
        that:
        - _create_instance is not failed
        - _create_instance is changed
        - _create_instance.instances is not defined
        - _create_instance.instance_ids is defined
        - _create_instance.instance_ids | length > 0

    - name: Gather instance info
      ec2_instance_info:
        filters:
          "tag:Name": "{{ ec2_test_name }}"
      register: _instances_info

    - name: Validate that the instance was created
      assert:
        that:
          - _instances_info.instances | length == 1
          - _instances_info.instances[0].state.name != 'running'

  vars:
    ec2_test_name: "{{ ec2_instance_name }}-no-wait"
  
  always:
    - name: Delete instance created
      ec2_instance:
        state: absent
        wait: false
        instance_ids: "{{ _create_instance.instance_ids }}"
      ignore_errors: true
      when: _create_instance is defined